{% extends "home/base.html" %}

{% load dayssince %}

{% load bootstrap3 %}
{% bootstrap_css %}
{% bootstrap_javascript %}

{% block salida %}active{% endblock %}

{% block script %}

<script type="text/javascript" language="javascript" src="{{ STATIC_URL }}JS/picnet.table.filter.min.js"></script>
<script type="text/javascript">
$(document).ready(function () {
  $('#avaluos_table').tableFilter();
  $('#id_Salida').datepicker({ autoSize: true , dateFormat: 'dd/mm/yy'});
  valor = 0;

  var rowCount = { p: $('#avaluos_table tbody tr:visible').length };
  valor = ($('#avaluos_table tbody tr:visible').length);

  $('#cantidad_tabla').html(valor);

  $('#avaluos_table thead').on("change", function () {
    setTimeout(function () {
      window.location = '/SIAV/salida/';
    }, 1000);
  });

$('#salida_masiva_button').click(function () {

    // Some code

    if($(".form-checkbox").is(':checked')) {

      var selected = [];
      var selected_depto = [];
      $('input:checked').each(function() {
          selected.push($(this).parent().next().next().next().next().next().next().next().next().html());
          selected_depto.push($(this).parent().next().next().next().next().html());
      });
      var bandera = true;
      var bandera_depto = true;
      for ( var i = 0; i < selected.length; i++ ) {
          // Logs "try 0", "try 1", ..., "try 4".
          
          // Comprueba que pertenezcan a la misma colonia
          if(selected[0] != selected[i]){
              bandera = false;
              console.log( selected[i] );
          }
          // Comprueba que pertenezcan al mismo departamento
          if(selected_depto[0] != selected_depto[i]){
              bandera_depto = false;
              console.log( selected_depto[i] );
          }
      }

      if(bandera == false){
        alert("Todos los servicios deben pertenecer a la misma colonia.");
      }else{
          if(bandera_depto != false){
            if(selected_depto[0]  == 54){
              //$( "#id_Importe" ).hide();
              //$("label[for='id_Importe']").hide();
              $("#id_Importe").val(696);
              $("#id_Importe").attr('readonly', true);
            }else{
              //$( "#id_Importe" ).show();
              //$("label[for='id_Importe']").show();
              $('#id_Importe').removeAttr('value');
              $("#id_Importe").attr('readonly', false);
            }
          }
        $('#salida_masiva').modal('show');
        console.log( selected.toString());
      }
      
      var selected = [];

       // $('#visita_masiva').modal('show');
    }else{
        alert("Selecciona al menos una casilla.");
    }

});



});

</script>

{% endblock %}      

{% block content %}
  <a id="salida_masiva_button"  title="Visita" style="float:right" class="btn btn-primary" role="button">
    <span class="glyphicon glyphicon-ok"></span>
    SALIDA
  </a>

<h1>Salida</h1>
<h2 style="text-align:left"><span id="cantidad_tabla"></span>  Servicios</h2>
<div id='printableArea' class="table-responsive">
<form id="modal-form" class="" method="post" action="/SIAV/salida_masiva/">
<table id='avaluos_table' class="table table-striped table-hover">
  <thead>
    <tr class="{% if a.Solicitud|dayssince|add:"0" > a.Depto.Tolerancia|add:"0" and a.Estatus != 'DETENIDO' %}danger{% endif%}">
      <th></th>
      <th style="width:40px">Folio K</th>
      <th style="width:40px" filter='true' >Referencia</th>
      <th filter-type='ddl'>Cliente</th>
      <th hidden="true" filter-type='ddl'>Depto</th>
      <th>Calle</th>
      <th filter='false'>Ext.</th>
      <th filter='false'>Int.</th>
      <th style="width:100px" filter-type='ddl'>Colonia</th>
      <th filter-type='ddl'>Municipio</th>
      <th filter-type='ddl'>Prioridad</th>
      <th style="width:10px" filter-type='ddl'>Status</th>
      <th filter='false'>Dias</th>
      <th style="width:10px" filter='false' class="tabla_opciones"></th>
    </tr>
  </thead>
  <tbody>
    {% for a in avaluos %}
    <tr class="{% if a.Solicitud|dayssince|add:"0" > a.Depto.Tolerancia|add:"0" and a.Estatus != 'DETENIDO' %}danger{% endif%}">
      <td style="width:40px" filter='false'><input class="form-checkbox" type="checkbox" value="{{ a.avaluo_id }}" name="avaluo_salida"></td>
      <td > {{a.FolioK}} </td>
      <td style="width:100px;"> {{a.Referencia}} </td>
      <td style="width:10px;"> {{a.Cliente}} </td>
      <td hidden="true" style="width:10px;"> {{a.Depto_id}} </td>
      <td style="width:200px"> {{a.Calle}} </td>
      <td style="width:3px;"> {{a.NumExt}} </td>
      <td style="width:10px;"> {{a.NumInt}} </td>
      <td style="width:200px;"> {{a.Colonia}} </td>
      <td style="width:200px;"> {{a.Municipio}} </td>
      <td style="width:3px;"> {{a.Prioridad}} </td>
      <td >
        <span class="label label-{%if a.Estatus = 'PROCESO'%}success{%elif a.Estatus = 'DETENIDO'%}default{%endif%}">{{a.Estatus}}</span>
      </td>
      <td style="width:35px;">{{ a.Solicitud|dayssince }}</td>
      <td style="width:60px;" class="tabla_opciones">
        <a href="/SIAV/edita_salida/{{a.avaluo_id}}">
          <button type="button" class="btn btn-primary btn-sm">
            <span class="glyphicon glyphicon-edit"></span>
          </button>
        </a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>


{% for a in avaluos %}
<!-- Modal1 -->
<div id="myModal{{a.FolioK}}" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
 <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
     <h3 align="center" id="myModalLabel">{{a.FolioK}}</h3> 
  </div>
  <div class="modal-body">
    <p align="center">¿Estás seguro que deseas dar salida a este servicio? </p>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Cancelar</button>
    <a href="/SIAV/salida_efectiva/{{a.avaluo_id}}" role="button" class="btn btn-primary">Confirmar</a>
  </div>
</div>
{% endfor %}


<div class="modal fade" id="salida_masiva">

<div class="modal-dialog">
<div class="modal-content">
  <div class="modal-body">

    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h2 style="text-align:center">Salida Múltiple</h2>
    <div class="modal-body">
      <span style="display: block">
        {% if not visita_masiva.is_valid %}
        <div class='hide'>invalid_form</div>
        {% endif %}
          {% csrf_token %}
          {% bootstrap_form salida_masiva layout='vertical'  %}
      </span>
    </div>
    <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
    <button type="submit" class="btn btn-success" id="submit-id-submit" style="float:right">Enviar</button>
  </form>
</div>
</div>
<!-- /.modal-content -->
</div>
<!-- /.modal-dialog -->

</div>
<!-- /.modal -->


{% endblock %}