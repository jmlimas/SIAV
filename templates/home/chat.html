{% extends "home/base.html" %}
<!DOCTYPE html>
<html>
<head>
  <title>Realtime Django</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <style type="text/css" title="currentStyle">
    @import "{{ STATIC_URL }}CSS/smoothness/jquery-ui-1.8.24.custom.css";
  </style>
  {% block script %}
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js" type="text/javascript"></script>
  <script>
    $(document).ready(function(){

      var objDiv = document.getElementById("comments");
      objDiv.scrollTop = objDiv.scrollHeight+10;

      var socket = io.connect('{{ request.META.HTTP_HOST }}', {port: 4000});
      
      socket.on('connect', function(){
        console.log("connect");
      });
      
	  var socket = io.connect();
		console.log('check 1', socket.socket.connected);
		socket.on('connect', function() {
		  console.log('check 2', socket.socket.connected);
		});
	  
      var entry_el = $('#comment');
               
      socket.on('message', function(message) {
        //Escape HTML characters
        var data = message.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
        
        //Append message to the bottom of the list
        $('#comments').append('<li>' + data + '</li>');
        window.scrollBy(0, 10000000000);
        entry_el.focus();

        var objDiv = document.getElementById("comments");
        objDiv.scrollTop = objDiv.scrollHeight+10;
      });
                     
      entry_el.keypress(function(event){

        //When enter is pressed send input value to node server
        if(event.keyCode != 13) return;
        var msg = entry_el.attr('value');
        if(msg){

           socket.emit('send_message', msg, function(data){
                console.log(data);
           });
        
        //Clear input value   
        entry_el.attr('value', '');
       }


      });


    });


  </script>
  {% endblock %} 
</head>
<body>
  {% block content %}
  <div id="comment_div" >
    <ul id="comments" style="overflow:scroll; height:400px;">
        {% for comment in comments %}
            <li>[{{comment.date|date:"h:m"}}]{{comment.user}}: {{comment.text}}</li>
        {% endfor %}
    </ul>
  </div>
    <input type="text" id="comment" name="comment" />
  {% endblock %}
</body>
</html>